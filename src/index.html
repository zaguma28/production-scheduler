<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生産計画スケジューラー</title>
    <link rel="stylesheet" href="styles.css">
    <script src="chart.min.js"></script>
</head>
<body>
    <!-- モード選択ダイアログ -->
    <div id="mode-dialog" class="modal" style="display:flex;">
        <div class="modal-content" style="max-width:400px;text-align:center;">
            <h2 style="margin-bottom:20px;">🏭 モード選択</h2>
            <p style="margin-bottom:24px;color:#666;">利用するモードを選択してください</p>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <button id="btn-worker-mode" class="btn btn-primary btn-large" style="width:100%;">
                    👷 作業者モード（閲覧のみ）
                </button>
                <div style="border-top:1px solid #eee;padding-top:16px;margin-top:8px;">
                    <input type="password" id="admin-password" placeholder="管理者パスワード" 
                           style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;box-sizing:border-box;">
                    <button id="btn-admin-mode" class="btn btn-secondary btn-large" style="width:100%;">
                        🔐 管理者モードでログイン
                    </button>
                </div>
            </div>
            <p id="mode-error" style="color:red;margin-top:12px;display:none;">パスワードが正しくありません</p>
        </div>
    </div>

    <div class="app-container">
        <!-- ヘッダー -->
        <header class="header">
            <h1>🏭 生産計画スケジューラー</h1>
            <div class="header-actions">
                <button id="btn-test-data" class="btn btn-secondary">
                    🧪 テストデータ
                </button>
                <button id="btn-sync-from-kintone" class="btn btn-secondary">
                    📥 kintoneから取得
                </button>
                <button id="btn-copy-prev-shapes" class="btn btn-secondary" title="前日の図形・メモを今日にコピー">
                    📋 前日の図形をコピー
                </button>
                <button id="btn-sync-to-kintone" class="btn btn-primary">
                    📤 kintoneへ送信
                </button>
                <button id="btn-switch-mode" class="btn btn-secondary" title="モード切替">
                    🔄 モード切替
                </button>
                <button id="btn-settings" class="btn btn-icon" title="設定">
                    ⚙️
                </button>
            </div>
        </header>

        <!-- タブナビゲーション -->
        <nav class="tabs">
            <button class="tab active" data-tab="gantt">📊 ガントチャート</button>
            <button class="tab" data-tab="schedule">📋 スケジュール一覧</button>
            <button class="tab" data-tab="add">➕ 新規追加</button>
            <button class="tab" data-tab="inventory">📦 在庫グラフ</button>
            <button class="tab" data-tab="balance">⚖️ 需給バランス</button>
        </nav>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- ガントチャートビュー -->
            <section id="gantt-view" class="view active">
                <div class="view-header">
                    <h2>ガントチャート</h2>
                    <!-- 凡例 -->
                    <div class="status-legend">
                        <div class="legend-item">
                            <span class="legend-marker status-inprogress"></span>
                            <span>生産中</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker status-pending"></span>
                            <span>未生産</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-marker status-completed"></span>
                            <span>生産終了</span>
                        </div>
                    </div>
                    <div class="date-selector">
                        <button id="prev-date" class="btn btn-small">◀</button>
                        <input type="date" id="gantt-date">
                        <button id="next-date" class="btn btn-small">▶</button>
                    </div>
                </div>
                <div id="gantt-container" class="gantt-container">
                    <div class="gantt-timeline"></div>
                    <div class="gantt-rows"></div>
                </div>
            </section>

            <!-- スケジュール一覧ビュー -->
            <section id="schedule-view" class="view">
                <div class="view-header">
                    <h2>スケジュール一覧</h2>
                    <div class="filter-controls">
                        <select id="filter-status">
                            <option value="">全ステータス</option>
                            <option value="予定">予定</option>
                            <option value="生産中">生産中</option>
                            <option value="完了">完了</option>
                        </select>
                    </div>
                </div>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>製品名</th>
                            <th>開始日時</th>
                            <th>終了日時</th>
                            <th>個数</th>
                            <th>備考</th>
                            <th>状態</th>
                            <th>同期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-tbody"></tbody>
                </table>
            </section>

            <!-- 新規追加ビュー -->
            <section id="add-view" class="view">
                <div class="view-header">
                    <h2>スケジュール追加</h2>
                </div>
                <form id="add-schedule-form" class="form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">製品名</label>
                            <select id="product-name" required>
                                <option value="">選択してください</option>
                                <option value="FS450D">FS450D (450kg)</option>
                                <option value="FS450K">FS450K (450kg)</option>
                                <option value="FS450NR">FS450NR (450kg)</option>
                                <option value="FS450S">FS450S (450kg)</option>
                                <option value="FS250C">FS250C (250kg)</option>
                                <option value="FS250CE">FS250CE (250kg)</option>
                                <option value="FS360F">FS360F (360kg)</option>
                                <option value="FS021">FS021 (20kg)</option>
                                <option value="FS021B">FS021B (20kg)</option>
                                <option value="FS021F">FS021F (20kg)</option>
                                <option value="FS021PF">FS021PF (20kg)</option>
                                <option value="FS021PS">FS021PS (20kg)</option>
                                <option value="小袋">小袋 (20kg)</option>
                                <option value="MEMO">📝 メモ・コメント</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity1">個数</label>
                            <input type="number" id="quantity1" min="0" placeholder="生産個数を入力">
                        </div>
                        <div class="form-group">
                            <label for="initial-status">初期ステータス（テスト用）</label>
                            <select id="initial-status">
                                <option value="未生産">未生産</option>
                                <option value="生産中">生産中</option>
                                <option value="生産終了">生産終了</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="start-datetime">開始日時</label>
                            <input type="datetime-local" id="start-datetime" required>
                        </div>
                        <div class="form-group">
                            <label for="efficiency">製綿能率 (t/h)</label>
                            <select id="efficiency">
                                <option value="4.00">4.00</option>
                                <option value="4.25">4.25</option>
                                <option value="4.50">4.50</option>
                                <option value="4.75">4.75</option>
                                <option value="5.00" selected>5.00</option>
                                <option value="5.25">5.25</option>
                                <option value="5.50">5.50</option>
                                <option value="5.75">5.75</option>
                                <option value="6.00">6.00</option>
                                <option value="6.25">6.25</option>
                                <option value="6.50">6.50</option>
                                <option value="6.75">6.75</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="end-datetime">終了日時（自動計算）</label>
                            <input type="datetime-local" id="end-datetime" readonly>
                        </div>
                        <div class="form-group">
                            <label for="notes">備考</label>
                            <input type="text" id="notes" placeholder="備考を入力">
                        </div>
                    </div>
                    <div class="form-actions" style="display: flex; align-items: center; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="go-to-list-after-add">
                            <span>登録後に一覧へ移動</span>
                        </label>
                        <div style="flex: 1;"></div>
                        <button type="submit" class="btn btn-primary btn-large">
                            ✅ スケジュールを追加
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            🔄 リセット
                        </button>
                    </div>
                </form>
            </section>

            <!-- 在庫グラフビュー -->
            <section id="inventory-view" class="view">
                <div class="view-header">
                    <h2>製品在庫グラフ</h2>
                </div>
                <div class="chart-container">
                    <canvas id="inventory-chart"></canvas>
                </div>
            </section>

            <!-- 需給バランスビュー -->
            <section id="balance-view" class="view">
                <div class="view-header">
                    <h2>⚖️ 需給バランス（14日間）</h2>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button id="btn-refresh-balance" class="btn btn-secondary">🔄 データ更新</button>
                        <span id="balance-status" style="font-size:13px;color:#888;"></span>
                    </div>
                </div>
                <div id="balance-content">
                    <p style="text-align:center;padding:40px;color:#999;">🔄 タブをクリックするとデータを自動取得します</p>
                </div>
            </section>
        </main>

        <!-- 設定モーダル -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>⚙️ kintone設定</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="settings-form" class="form">
                    <div class="form-group">
                        <label for="subdomain">サブドメイン</label>
                        <input type="text" id="subdomain" placeholder="例: your-company" required>
                        <small>.cybozu.com が自動で付加されます</small>
                    </div>
                    <div class="form-group">
                        <label for="app-id">アプリID</label>
                        <input type="number" id="app-id" placeholder="例: 351" required>
                    </div>
                    <div class="form-group">
                        <label for="api-token">スケジュール用 APIトークン (ID 506)</label>
                        <input type="password" id="api-token" placeholder="APIトークンを入力" required>
                    </div>
                    <div style="border-top:1px solid #eee; margin:20px 0;"></div>
                    <div class="form-group">
                        <label for="memo-app-id">メモ・図形用 アプリID (ID 507)</label>
                        <input type="number" id="memo-app-id" placeholder="例: 507">
                    </div>
                    <div class="form-group">
                        <label for="memo-api-token">メモ・図形用 APIトークン</label>
                        <input type="password" id="memo-api-token" placeholder="APIトークンを入力">
                    </div>
                    <div style="border-top:1px solid #eee; margin:20px 0;"></div>
                    <h3 style="margin-bottom:12px;font-size:15px;">⚖️ 需給バランス用</h3>
                    <div class="form-group">
                        <label for="tsumikomi-app-id">積込予定 アプリID (ID 514)</label>
                        <input type="number" id="tsumikomi-app-id" placeholder="例: 514">
                    </div>
                    <div class="form-group">
                        <label for="tsumikomi-api-token">積込予定 APIトークン</label>
                        <input type="password" id="tsumikomi-api-token" placeholder="APIトークンを入力">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">💾 保存</button>
                        <button type="button" id="test-connection" class="btn btn-secondary">🔗 接続テスト</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ステータスバー -->
        <footer class="status-bar">
            <span id="status-message">準備完了</span>
            <span id="sync-status">同期: 未接続</span>
        </footer>

        <!-- メモ追加モーダル -->
        <div id="memo-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>📝 メモを追加</h2>
                    <button class="modal-close" id="memo-modal-close">&times;</button>
                </div>
                <form id="memo-form" class="form">
                    <div class="form-group">
                        <label for="memo-text">メモ内容</label>
                        <textarea id="memo-text" rows="4" placeholder="コメントを入力..." required style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--system-gray4);font-size:15px;resize:vertical;"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">✅ 追加</button>
                        <button type="button" id="memo-modal-cancel" class="btn btn-secondary">キャンセル</button>
                    </div>
                </form>
            </div>
                </div>

        <!-- 図形追加モーダル -->
        <div id="shape-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>🔷 図形を追加</h2>
                    <button class="modal-close" id="shape-modal-close">&times;</button>
                </div>
                <form id="shape-form" class="form">
                    <div class="form-group">
                        <label for="shape-type">図形の種類</label>
                        <select id="shape-type">
                            <option value="arrow-right">➡️ 右矢印</option>
                            <option value="arrow-down">⬇️ 下矢印</option>
                            <option value="star">⭐ 星</option>
                            <option value="warning">⚠️ 警告</option>
                            <option value="check">✅ チェック</option>
                            <option value="important">❗ 重要</option>
                            <option value="circle">🔴 丸印</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="shape-text">ラベル（任意）</label>
                        <input type="text" id="shape-text" placeholder="図形にテキストを追加...">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">✅ 追加</button>
                        <button type="button" id="shape-modal-cancel" class="btn btn-secondary">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    <!-- 右クリックコンテキストメニュー -->
    <div id="context-menu" style="display:none;position:fixed;background:rgba(255,255,255,0.98);backdrop-filter:blur(20px);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.25);padding:8px 0;min-width:180px;z-index:9999;border:1px solid rgba(0,0,0,0.1);">
        <div class="context-menu-item" data-action="add-memo" style="padding:12px 20px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:10px;">
            📝 メモを追加
        </div>
        <div class="context-menu-item" data-action="add-shape" style="padding:12px 20px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:10px;">
            🔷 図形を追加
        </div>
    </div>
    </div>

    <!-- モード切替ボタン（作業者モード用） -->
    <button id="worker-mode-switch-btn" class="btn btn-secondary" style="display:none; position:fixed; bottom:30px; left:30px; z-index:9999; padding:12px 24px; font-weight:bold; font-size:16px;">
        🔄 モード切替
    </button>

    <script src="app.js?v=20260204201004"></script>
</body>
</html>

